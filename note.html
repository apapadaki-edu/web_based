<!DOCTYPE html>

<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1">
        <title>NoteApp</title>
        <link rel="stylesheet" href="note.css">
        <script src="https://kit.fontawesome.com/be3ff5ad85.js" crossorigin="anonymous"></script>        
        <script type="text/javascript">
            // <![CDATA[
            //second option
            // checking for compatibility
            window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
            window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
            window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
            // if not compatible display error message
            if (!window.indexedDB) {
                console.log("IndexedDB not supported in your browser.");
            }

            var db; // to store the db instance
            var request = window.indexedDB.open("notesDB", 1);
            request.onerror = function(event) {
                console.log("error: " + event.target.errorCode);
            }
            
            request.onsuccess = function(event) {
                db = request.result;
                console.log("success: "+ db);
                readAll(); //if db opened successfully we can read the data of the database
            }

            // on db version update handler
            request.onupgradeneeded = function(event) { 
                var db = event.target.result;
                var objectStore = db.createObjectStore("notes", {keyPath:"date"});
            }

            // when a user creates a note the note is stored in the database with key the date of creation
            // when the user madifies an already existing note the old one gets deleted and a new one is created

            function add() {
                var objectStore = db.transaction(["notes"], "readwrite").objectStore("notes");
                let noteKey = document.forms['edit-part'].elements.date.value;
                if (!noteKey){
                    var requestAdd = objectStore.add(
                        { date: Date.now() + "",
                            title: document.forms['edit-part'].elements.title.value, 
                            colorTheme: document.forms['edit-part'].elements.themeColor.value, 
                            body: document.forms['edit-part'].elements.body.value
                        });
                    requestAdd.onsuccess = function(event) {
                        console.log("The note has been added.");
                    };
                    requestAdd.onerror = function(event) {
                        console.log("Unable to add this note.");
                    };
                }
                else {
                    var requestRemove = objectStore.delete(noteKey);
                    requestRemove.onerror = function(event) {
                        console.log("Unable to deletedata from the database!");
                    };
                    requestRemove.onsuccess = function(event) {

                        var requestUpdate = objectStore.add(
                        { date: Date.now() + "",
                            title: document.forms['edit-part'].elements.title.value, 
                            colorTheme: document.forms['edit-part'].elements.themeColor.value,
                            body: document.forms['edit-part'].elements.body.value
                        });
                        requestUpdate.onsuccess = function(event) {
                            console.log("The note has been updated.");
                        };
                        requestUpdate.onerror = function(event) {
                            console.log("Unable to update this note.");
                        };
                    }
                }
            }

            // reads a note from the database with the specified date as key 
            //(the date is set to the note's div id attribute)
            function read(date) {
                var request = db.transaction(["notes"])
                    .objectStore("notes")
                    .get(date);
                request.onerror = function(event) {
                    console.log("Unable to retrieve data from the database!");
                };
                request.onsuccess = function(event) {
                    if(request.result) {
                        document.getElementById('list-part').style.display = 'none';
                        document.getElementById('edit-part').style.display = 'flex';
                        document.getElementById("date").value = request.result.date;
                        document.getElementById("title").value = request.result.title;
                        Array.from(document.getElementById("themeColor")).find(theme => theme.value === request.result.colorTheme).selected = true;
                        document.getElementById("themeColorAssist").style.backgroundColor = request.result.colorTheme; 
                        document.forms['edit-part'].elements.body.value = request.result.body;
                    }
                    else {
                        console.log("The requested note couldn't be found!");
                    }
                };
            }

            // retrieves all the entries in the database and displays them on the front page
            function readAll() {
                var request = db.transaction(["notes"])
                    .objectStore("notes")
                    .getAll();
                request.onsuccess = function(event) {
                    // loop over the records retrieved in event.target.result
                    var inner = "";
                    event.target.result.forEach(function(note) {
                        //set its attributes and content
                        let date = new Date(parseInt(note.date));
                        inner += '<div id="' + note.date + '" class="note" onclick="read(this.id);">\
                                    <p>' + note.title + '</p><p>' + date.toISOString().split('T')[0] 
                                    + '</p><p id="theme" style="background-color:' + note.colorTheme + '"></p></div>';
                        // add it to the respactive container in home page
                        document.getElementById("notes-container").innerHTML = inner;
                    });
                    document.querySelector('#count').innerText = event.target.result.length;
                }
            }


            // removes an entry from the database
            function remove() {
                var request = db.transaction(["notes"], "readwrite")
                .objectStore("notes")
                .delete(document.getElementById('date').value); // key of the entry
                request.onsuccess = function(event) {
                    console.log("entry has been removed.");
                };
            };
            
            function clear_db() {
                var request = db.transaction(["notes"], "readwrite")
                .objectStore("notes").clear();
                request.onsuccess  = function(event) {
                    console.log("database empted");
                }
                request.onerror = function(event) {
                    console.log("something went-wrong")
                }

                let noteContainer = document.querySelector("#notes-container")
                let firstNoteChild = noteContainer.firstElementChild;
                while(firstNoteChild) {
                    firstNoteChild.remove();
                    firstNoteChild = noteContainer.firstElementChild;
                }

                document.getElementById("count").innerHTML = 0;
            }

            // toggles between the front page that lists all notes and the new note section
            function changeVisibilityStatus(trigId){
                let list = document.getElementById('list-part');
                let note = document.getElementById('edit-part');
                if (trigId =='new-note'){
                    list.style.display = 'none';
                    note.style.display = 'flex';
                } else {
                    note.style.display = 'none';
                    list.style.display = 'flex';
                }
            }
            
            window.addEventListener('load', function(){
                document.querySelector('#themeColor').selected = true;
                document.querySelector('#themeColor').addEventListener('change', function(){
                    document.getElementById('themeColorAssist').style.backgroundColor =  this.value;
                })
            });

        // ]]>   

        </script>
    </head>
    <body>
        <div class="container">
            <h1> Note Pad </h1>
            <section id="list-part">
                <nav>
                    <div id="count">0</div>
                    <button id="new-note" onclick="changeVisibilityStatus(this.id)">New</button>
                    <button id="clear-storage" onclick="clear_db()">Clear</button>
                </nav>
                <div id="notes-container">
                </div> 
            </section>
            <form id="edit-part" style="display:none">
                <input type="text" id="date" name="date" hidden>
                <input type="text" id="title" name="title" placeholder="Title...">
                <div id="theme-field">
                    <select id="themeColor" name="themeColor">
                        <option value="#bfa35a">Remainder</option>
                        <option value="#8a2f2b">Important</option>
                        <option value="#308043">Shopping</option>
                        <option value="#2f5c97">Plan</option>
                        <option value="#ebeded" selected="1">No Theme</option>
                    </select>
                    <div id="themeColorAssist"></div>
                </div>
                <textarea id="body" name="body" placeholder="Text..."></textarea>

                <fieldset id="note-actions">
                    <button id="save-note" onclick="changeVisibilityStatus(this.id);add();">Save</button>
                    <button id="delete-note" onclick="changeVisibilityStatus(this.id);remove();">Delete</button>
                    <button id="cancel-note" onclick="changeVisibilityStatus(this.id);">Cancel</button>
                </fieldset>
            </form>
        </div>
    </body>
</html>
